---
layout: post
title: "HTTPS协议的由来"
date: 2017-04-06
comments: false
categories: NETWORK
---

一提到HTTPS，第一印象就是安全，可是具体怎么安全，为什么安全，可能就说不上来，我不断查阅了资料，对HTTPS也有了一定的理解，现在用一个比较恰当的故事来表示HTTPS的由来.

### 0. 背景

A、B、C是同班同学，A和B同时喜欢C，A、B、C坐位依次。大家可以把A理解为客户端、B理解为中间网络（网络设备、运营商、中间服务器），C理解为服务器

### 1. 阶段1（HTTP）

有一天A发明了递纸条的方法，于是A写好纸条，让B帮忙交给C，C收到后，同样方式回复给A

```
 ---           ---           ---
|   |   HTTP  |   |   HTTP  |   |
|   |-------->|   |-------->|   |
| A |   HTTP  | B |   HTTP  | C |
|   |<--------|   |<--------|   |
|   |         |   |         |   |
 ---           ---           ---
```

问题1：B既然也喜欢C，而B就可以看到A与C写的字条，于是就偷偷篡改里面的内容，于是A与C就无法正常进行通讯

### 2. 阶段2（对称加密）

A在想，竟然B可以看到纸条内容，于是就想到通过加密把纸条内容比为密文，这样大家就看不到里面的内容，可是前提，需要把密码告诉对方，这样对方才能解密。

问题2：如何传递密码呢？因为所有数据都得经过B，如何把这个密码传递给C，直接传递，这样B也就知道了如何解密，这样加密就没有任何意义。


### 3. 阶段3（非对称加密，不受信任访问）

上一阶段提到了如何传递密码，A经过苦思幂想，终于发明了非对称加密（公钥、私钥），即用公钥加密的内容，可以用私钥解密。A、C分别拥有自己的公私钥，于是正常通信过程就如下

```
 ---           ---           ---
|   |----1--->|   |----2--->|   |
|   |<---4----|   |<---3----|   |
| A |----5--->| B |----6--->| C |
|   |         |   |         |   |
|   |<---7--->|   |<---8--->|   |
 ---           ---           ---

1 2 - 获取C公钥
3 4 - 返回C公钥
5 6 - A利用C公钥加密密码
7 8 - A和C利用对称密码进行数据的加解密
```

问题3：这样A与C又可以正常通信，直到有天B也发现了公私钥，于是B也生成了公私钥，并采用了如下方式进行信息窃取

```
 ---           ---           ---
|   |----1--->|   |----2--->|   |
|   |<---4----|   |<---3----|   |
| A |----5--->| B |----6--->| C |
|   |<---8----|   |<---7----|   |
|   |<---10-->|   |<---11-->|   |
 ---           ---           ---

1 2 - 获取C公钥
3 4 - 返回C公钥
5 6 - 发送利用C公钥加密后的A公钥及对称密钥A
7 8 - 发送利用A公钥加密后的对称密钥C
10  - A利用对称密钥C收数据，利用对称密钥A发送数据
11  - C利用对称密钥A收数据，利用对称密钥C发送数据
```
PS: 于是A与C又无法正常通信了，当然这里插入个问题：`为何数据不用非对称加密，这样就不用传递对称密钥？` 这是因为对称加密效率要比非对称高，因此采用对称加密，可以保证效率，否则HTTPS性能堪忧.

### 4. 阶段4（数字证书）

A又经过一夜的苦思幂想，想到了可以使用数字证书方案（所谓数字证书，就相当于身份证，跟人是一一对应的，无法伪造），于是A让C到CA（Certificate Authority）中心申请盖章，因此C就拥有一个由CA盖章的公钥，这样即使B也去申请，但CA认为身份不合法，不给批。这样A在获取到C公钥后会通过CA校验这个公钥是否属于C，因此B就无法伪造，于是B就无法获取到对称密钥，即最终A、C就可以安全地通信。

```
 ---           ---           ---
|   |----1--->|   |----2--->|   |
|   |<---4----|   |<---3----|   |
| A 9----5--->| B |----6--->| C |
|   |<---8----|   |<---7----|   |
|   |<---10-->|   |<---11-->|   |
 ---           ---           ---

1 2 - 获取C公钥
3 4 - 返回C公钥
9   - A对C公钥进行校验，当确认是C的公钥，则继续会话，否则结束
5 6 - 发送利用C公钥加密后的A公钥及对称密钥A
7 8 - 发送利用A公钥加密后的对称密钥C
10  - A利用对称密钥C收数据，利用对称密钥A发送数据
11  - C利用对称密钥A收数据，利用对称密钥C发送数据
```

PS: 与阶段3的区别是，多了步骤9，客户端需要对C公钥进行校验。


