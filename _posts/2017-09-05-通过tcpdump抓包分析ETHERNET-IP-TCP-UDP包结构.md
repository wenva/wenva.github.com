---
layout: post
title: "通过tcpdump抓包分析ETHERNET-IP-TCP-UDP包结构"
date: 2017-09-05
comments: false
categories: 网络
---

抓包是学习网络协议的有效途径，通过实际分析，使得"理论"不那么枯燥，本文会通过抓包来分析各类包结构。

为了方便理解，大家需要先有以下概念：

* TCP包结构 - [ ETHERNET头 [ IP头 [ TCP头 [ ... ] ] ] ]
* UDP包结构 - [ ETHERNET头 [ IP头 [ UDP头 [ ... ] ] ] ]

有了以上概念，下面放上我抓取的TCP包（HTTP）

sudo tcpdump -i en0 port 80 -XX
<pre>
17:17:29.484811 IP 192.168.12.101.63895 > 119.29.177.26.http: Flags [P.], seq 1:80, ack 1, win 4103, options [nop,nop,TS val 53585color3116 ecr 3024973830], length 79: HTTP: GET / HTTP/1.1
    0x0000:  <font color="#E97D00">d0c7 c08a 1a7c 6003 0899 962a 0800</font> <font color="#03AF59">4500
    0x0010:  0083 68c9 4000 4006 dc66 c0a8 0c65 771d
    0x0020:  b11a</font> <font color="#55A8E7">f997 0050 6046 44fe ae85 07c8 8018
    0x0030:  1007 21bd 0000 0101 080a 1ff0 783c b44d
    0x0040:  7006 4745 5420 2f20 4854 5450 2f31 2e31
    0x0050:  0d0a 486f 7374 3a20 7777 772e 762d 6a75
    0x0060:  2e63 6f6d 2e63 6e0d 0a55 7365 722d 4167
    0x0070:  656e 743a 2063 7572 6c2f 372e 3531 2e30
    0x0080:  0d0a 4163 6365 7074 3a20 2a2f 2a0d 0a0d
    0x0090:  0a</font>
</pre>

#### <font color="#E97D00">ETHERNET</font>
```
        0             8                               24
       -------------------------------------------------
       |                 destination mac               |
       -------------------------------------------------
       |                   source mac                  |
       -------------------------------------------------
       |     type     |
       ----------------
```

* 总共14字节 = 6字节目的mac + 6字节源mac + 2字节类型
* 实际得出：

    - 目的MAC - d0:c7:c0:8a:1a:7c
    - 源MAC   - 60:03:08:99:96:2a
    - 类型    - 0800（IPV4）

#### <font color="#03AF59">IP</font>

#### <font color="#55A8E7">TCP</font>

```
        0                            15                              31
       -----------------------------------------------------------------
       |          source port          |       destination port        |
       -----------------------------------------------------------------
       |                        sequence number                        |
       -----------------------------------------------------------------
       |                     acknowledgment number                     |
       -----------------------------------------------------------------
       |  HL   | rsvd  |C|E|U|A|P|R|S|F|        window size            |
       -----------------------------------------------------------------
       |         TCP checksum          |       urgent pointer          |
       -----------------------------------------------------------------
```
